<!DOCTYPE html>
<html lang="pt-br">
 <head>
  {% include 'partials/_head.html' %}
 </head>
 <body>
  <div class="flex-wrapper">
   {% include 'partials/_nav.html' %}
   <section class="form-container">
    <div class="container">
     <div class="header-bar">
      Cadastrar Professor
     </div>
    </div>
    <div class="content-wrapper" style="padding-top: 0; margin-top: 0;">
     <form action="cadastrar_professor/" id="professorForm" method="post">
      {% csrf_token %}
      <h3>
       Informa√ß√µes Pessoais
      </h3>
      <div class="form-row">
       <div class="form-group short-field">
        <label for="doctorCpf">
         CPF
        </label>
        <div class="input-group-cpf">
         <input id="doctorCpf" name="doctorCpf" oninput="mascaraCpf(this)" placeholder="000.000.000-00" required="" type="text"/>
         <button class="btn" onclick="buscarCpf()" type="button">
          Buscar
         </button>
        </div>
       </div>
       <div class="form-group">
        <label for="doctorName">
         Nome Completo
        </label>
        <input id="doctorName" name="doctorName" required="" type="text"/>
       </div>
       <div class="form-group short-field">
        <label for="birthdate">
         Data de Nascimento
        </label>
        <input id="birthdate" name="birthdate" required="" type="date"/>
       </div>
      </div>
      <div class="form-row">
       <div class="form-group">
        <label for="email">
         E-mail
        </label>
        <input id="email" name="email" required="" type="email"/>
       </div>
       <div class="form-group">
        <label for="phone">
         Telefone
        </label>
        <input id="phone" name="phone" required="" type="tel"/>
       </div>
       <div class="form-group short-field">
        <label for="cep">
         CEP
        </label>
        <input id="cep" name="cep" required="" type="text"/>
       </div>
      </div>
      <div class="form-row">
       <div class="form-group">
        <label for="address">
         Logradouro
        </label>
        <input id="address" name="address" required="" type="text"/>
       </div>
       <div class="form-group short-field">
        <label for="number">
         N√∫mero
        </label>
        <input id="number" name="number" required="" type="text"/>
       </div>
       <div class="form-group short-field">
        <label for="complement">
         Complemento
        </label>
        <input id="complement" name="complement" type="text"/>
       </div>
      </div>
      <div class="form-row">
       <div class="form-group">
        <label for="bairro">
         Bairro
        </label>
        <input id="bairro" name="bairro" required="" type="text"/>
       </div>
       <div class="form-group">
        <label for="city">
         Cidade
        </label>
        <input id="city" name="city" required="" type="text"/>
       </div>
       <div class="form-group short-field">
        <label for="state">
         Estado
        </label>
        <input id="state" name="state" required="" type="text"/>
       </div>
      </div>
      <h3>
       Dados Profissionais
      </h3>
      <div class="form-row">
       <div class="form-group">
        <label for="cargo">
         Cargo
        </label>
        <select id="cargo" name="cargo" required="">
         <option value="professor">
          Professor
         </option>
         <option value="diretor">
          Diretor
         </option>
         <option value="coordenador">
          Coordenador
         </option>
        </select>
       </div>
       <div class="form-group">
        <label for="formacao">
         Forma√ß√£o
        </label>
        <input id="formacao" name="formacao" required="" type="text"/>
       </div>
      </div>
      <div class="form-row">
       <div class="form-group">
        <label for="experiencia">
         Experi√™ncia
        </label>
        <textarea id="experiencia" name="experiencia" required=""></textarea>
       </div>
       <div class="form-group short-field">
        <label for="sexo">
         Sexo
        </label>
        <select id="sexo" name="sexo">
         <option value="masc">
          Masculino
         </option>
         <option value="femi">
          Feminino
         </option>
        </select>
       </div>
       <div class="form-group short-field">
        <label for="ativo">
         Ativo
        </label>
        <select id="ativo" name="ativo">
         <option value="true">
          Sim
         </option>
         <option value="false">
          N√£o
         </option>
        </select>
       </div>
      </div>
      <div class="form-row">
       <div class="form-group">
        <label for="senha_temporaria">
         Senha Tempor√°ria
        </label>
        <input class="form-control" id="senha_temporaria" readonly="" style="background-color: #f1f1f1;" type="text"/>
       </div>
      </div>
      <div class="form-footer">
       <button class="btn btn-primary" id="submitButton" type="submit">
        Cadastrar
       </button>
       <button class="btn btn-secondary" onclick="window.location.href='{% url 'index' %}'" type="button">
        Cancelar
       </button>
      </div>
     </form>
    </div>
   </section>
   <footer>
    {% include 'partials/_footer.html' %}
   </footer>
  </div>
  <script>
   // Todas as fun√ß√µes JS continuam funcionais com o campo disciplinas removido
    // Apenas foram removidas as refer√™ncias a 'disciplinas'

    function gerarSenhaTemporaria(tamanho = 8) {
        const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        let senha = "";
        for (let i = 0; i < tamanho; i++) {
            senha += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
        }
        return senha;
    }

    const senhaTemporariaGerada = gerarSenhaTemporaria();

    const fields = [
        'doctorCpf', 'doctorName', 'birthdate', 'email', 'phone', 
        'cep', 'address', 'number', 'complement', 'bairro',
        'city', 'state', 'cargo', 'formacao', 'experiencia', 'sexo', 'ativo',
    ];

    function enableFields() {
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = false;
        });
        document.getElementById("submitButton").disabled = false;
    }

    function mascaraCpf(input) {
        input.value = input.value
            .replace(/\D/g, '')
            .replace(/(\d{3})(\d)/, '$1.$2')
            .replace(/(\d{3})(\d)/, '$1.$2')
            .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }

    function buscarCpf() {
        const cpf = document.getElementById("doctorCpf").value;
        if (!cpf) {
            alert("Informe um CPF v√°lido.");
            return;
        }

        fetch('/buscar_cpf/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ doctorCpf: cpf })
        })
        .then(res => res.json())
        .then(data => {
            if (data.exists) {
                alert("Professor j√° cadastrado.");
            } else {
                enableFields();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        enableFields();
        document.getElementById('senha_temporaria').value = senhaTemporariaGerada;
    });

    document.getElementById('submitButton').addEventListener('click', function(event) {
        event.preventDefault();

        const dados = {};
        fields.forEach(id => {
            dados[id] = document.getElementById(id).value.trim();
        });
        dados['senha'] = senhaTemporariaGerada;

        fetch('/cadastrar_professor_banco/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(dados)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("‚úÖ Professor cadastrado com sucesso!");
            } else {
                alert("‚ùå Erro: " + (data.error || "N√£o foi poss√≠vel cadastrar."));
            }
        })
        .catch(error => {
            alert("‚ùå Erro inesperado.");
            console.error("üö® Erro na requisi√ß√£o:", error);
        });
    });
  </script>
 </body>
</html>
