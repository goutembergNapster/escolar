<!DOCTYPE html>
<html lang="pt-br">
 {% include 'partials/_head.html' %}
 <body>
  {% include 'partials/_nav.html' %}
  <section class="content-wrapper" style="margin-top: 15px;">
   <div class="header-bar">
    Cadastrar Escola
   </div>
   <form id="schoolForm">
    {% csrf_token %}
    <div class="form-row">
     <div class="form-group short-field">
      <label for="schoolCnpj">
       CNPJ
      </label>
      <div class="input-group-cnpj">
       <input id="schoolCnpj" maxlength="18" name="cnpj" oninput="this.value = mascaraCnpj(this.value)" placeholder="00.000.000/0000-00" required="" type="text"/>
       <button onclick="buscarCnpj()" type="button">
        Buscar
       </button>
      </div>
     </div>
     <div class="form-group">
      <label for="schoolName">
       Nome da Escola
      </label>
      <input class="disabled-field" id="schoolName" name="nome" placeholder="Nome da Escola" readonly="" type="text"/>
     </div>
    </div>
    <div class="form-row">
     <div class="form-group short-field">
      <label for="schoolEmail">
       E-mail
      </label>
      <input class="disabled-field" id="schoolEmail" name="email" placeholder="email@escola.com.br" readonly="" type="email"/>
     </div>
     <div class="form-group short-field">
      <label for="schoolPhone">
       Telefone
      </label>
      <input class="disabled-field" id="schoolPhone" name="telefone" placeholder="(xx) xxxx-xxxx" readonly="" type="text"/>
     </div>
    </div>
    <div class="form-row">
     <div class="form-group">
      <label for="schoolCep">
       CEP
      </label>
      <input class="disabled-field" id="schoolCep" name="cep" placeholder="00000-000" readonly="" type="text"/>
     </div>
     <div class="form-group">
      <label for="schoolStreet">
       Logradouro
      </label>
      <input class="disabled-field" id="schoolStreet" name="endereco" placeholder="Rua / Avenida" readonly="" type="text"/>
     </div>
     <div class="form-group short-field">
      <label for="schoolNumber">
       N√∫mero
      </label>
      <input class="disabled-field" id="schoolNumber" name="numero" readonly="" type="text"/>
     </div>
    </div>
    <div class="form-row">
     <div class="form-group short-field">
      <label for="schoolComplement">
       Complemento
      </label>
      <input class="disabled-field" id="schoolComplement" name="complemento" readonly="" type="text"/>
     </div>
     <div class="form-group">
      <label for="schoolNeighborhood">
       Bairro
      </label>
      <input class="disabled-field" id="schoolNeighborhood" name="bairro" readonly="" type="text"/>
     </div>
    </div>
    <div class="form-row">
     <div class="form-group">
      <label for="schoolCity">
       Cidade
      </label>
      <input class="disabled-field" id="schoolCity" name="cidade" readonly="" type="text"/>
     </div>
     <div class="form-group short-field">
      <label for="schoolState">
       Estado
      </label>
      <select class="disabled-field" disabled="" id="schoolState" name="estado">
       <option value="">
        Escolher...
       </option>
       <option>
        AC
       </option>
       <option>
        AL
       </option>
       <option>
        AP
       </option>
       <option>
        AM
       </option>
       <option>
        BA
       </option>
       <option>
        CE
       </option>
       <option>
        DF
       </option>
       <option>
        ES
       </option>
       <option>
        GO
       </option>
       <option>
        MA
       </option>
       <option>
        MT
       </option>
       <option>
        MS
       </option>
       <option>
        MG
       </option>
       <option>
        PA
       </option>
       <option>
        PB
       </option>
       <option>
        PR
       </option>
       <option>
        PE
       </option>
       <option>
        PI
       </option>
       <option>
        RJ
       </option>
       <option>
        RN
       </option>
       <option>
        RS
       </option>
       <option>
        RO
       </option>
       <option>
        RR
       </option>
       <option>
        SC
       </option>
       <option>
        SP
       </option>
       <option>
        SE
       </option>
       <option>
        TO
       </option>
      </select>
     </div>
     <div class="form-group">
      <label for="schoolWebsite">
       Site
      </label>
      <input class="disabled-field" id="schoolWebsite" name="site" placeholder="www.escola.com.br" readonly="" type="url"/>
     </div>
    </div>
    <div class="form-footer">
     <button class="btn btn-secondary" id="resetButton" onclick="resetForm()" type="button">
      Limpar
     </button>
     <button class="btn btn-secondary" disabled="" id="alterarButton" onclick="enableFields()" type="button">
      Alterar
     </button>
     <button class="btn btn-primary" id="submitButton" type="button">
      Cadastrar Escola
     </button>
     <button class="btn btn-secondary" id="cancelButton" onclick="window.location.href='{% url 'index' %}'" type="button">
      Cancelar
     </button>
    </div>
   </form>
  </section>
  <footer>
   {% include 'partials/_footer.html' %}
  </footer>
  <script>
   const fields = [
            'schoolName', 'schoolEmail', 'schoolPhone', 'schoolStreet',
            'schoolNumber', 'schoolComplement', 'schoolNeighborhood',
            'schoolCity', 'schoolState', 'schoolWebsite', 'schoolCep', 'schoolCnpj'
        ];
    
        function enableFields() {
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.readOnly = false;
                    el.disabled = false;
                    el.classList.remove('disabled-field');
                }
            });
        }
    
        function disableFields() {
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.readOnly = true;
                    el.disabled = true;
                    el.classList.add('disabled-field');
                }
            });
        }
    
        function limparCampos() {
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        }
    
        function preencherCampos(data) {
            for (let key in data) {
                const el = document.getElementById(key);
                if (el) el.value = data[key];
            }
        }
    
        function mascaraCnpj(value) {
            value = value.replace(/\D/g, '');
            if (value.length > 14) value = value.slice(0, 14);
            return value
                .replace(/^(\d{2})(\d)/, '$1.$2')
                .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
                .replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3/$4')
                .replace(/^(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/, '$1.$2.$3/$4-$5');
        }
    
        function validarCNPJ(cnpj) {
            cnpj = cnpj.replace(/[^\d]+/g, '');
            if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
    
            let tamanho = cnpj.length - 2;
            let numeros = cnpj.substring(0, tamanho);
            let digitos = cnpj.substring(tamanho);
            let soma = 0;
            let pos = tamanho - 7;
    
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
    
            let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != digitos.charAt(0)) return false;
    
            tamanho++;
            numeros = cnpj.substring(0, tamanho);
            soma = 0;
            pos = tamanho - 7;
    
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
    
            resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            return resultado == digitos.charAt(1);
        }
    
        function buscarCnpj() {
            const cnpjInput = document.getElementById("schoolCnpj");
            const cnpj = cnpjInput.value.trim();
    
            if (!cnpj) {
                alert("Por favor, preencha o campo de CNPJ.");
                return;
            }
    
            if (!validarCNPJ(cnpj)) {
                alert("CNPJ inv√°lido.");
                return;
            }
    
            fetch("/buscar_cnpj/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ cnpj })
            })
            .then(res => res.json())
            .then(data => {
                if (data.exists) {
                    preencherCampos(data.escola);
                    disableFields();
                    document.getElementById('submitButton').disabled = true;
                    document.getElementById('alterarButton').disabled = false;
                } else {
                    limparCampos();
                    enableFields();
                    document.getElementById('submitButton').disabled = false;
                    document.getElementById('alterarButton').disabled = true;
                }
            })
            .catch(error => {
                alert("Erro ao buscar o CNPJ.");
                console.error("Erro na requisi√ß√£o:", error);
            });
        }
    
        document.getElementById('submitButton').addEventListener('click', function(event) {
            event.preventDefault();
    
            const dados = {
                schoolName: document.getElementById('schoolName').value.trim(),
                schoolCnpj: document.getElementById('schoolCnpj').value.trim(),
                schoolPhone: document.getElementById('schoolPhone').value.trim(),
                schoolEmail: document.getElementById('schoolEmail').value.trim(),
                schoolStreet: document.getElementById('schoolStreet').value.trim(),
                schoolNumber: document.getElementById('schoolNumber').value.trim(),
                schoolComplement: document.getElementById('schoolComplement').value.trim(),
                schoolNeighborhood: document.getElementById('schoolNeighborhood').value.trim(),
                schoolCity: document.getElementById('schoolCity').value.trim(),
                schoolState: document.getElementById('schoolState').value.trim(),
                schoolWebsite: document.getElementById('schoolWebsite').value.trim(),
                schoolCep: document.getElementById('schoolCep').value.trim()
            };
    
            for (let key in dados) {
                if (!dados[key] && key !== 'schoolComplement' && key !== 'schoolWebsite') {
                    alert(`Preencha o campo obrigat√≥rio: ${key}`);
                    return;
                }
            }
    
            console.log("üì¶ Dados a enviar:", dados);
    
            fetch("/cadastrar_escola_banco/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                    
                },
                body: JSON.stringify(dados)
            })
            .then(res => {
            console.log("üîç Status da resposta:", res.status);
            return res.json();
            })
            .then(data => {
                if (data.success) {
                    alert("‚úÖ Escola cadastrada com sucesso!");
                    disableFields();
                    document.getElementById('submitButton').disabled = true;
                    document.getElementById('alterarButton').disabled = false;
                } else {
                    alert("‚ùå Erro: " + (data.error || "N√£o foi poss√≠vel cadastrar."));
                    console.error("Erro no backend:", data);
                }
            })
            .catch(error => {
                alert("‚ùå Erro ao enviar dados. Veja o console.");
                console.error("üö® Erro na requisi√ß√£o:", error);
            });
        });
  </script>
 </body>
</html>
