<!DOCTYPE html>
<html lang="pt-br">
 <head>
  {% include 'partials/_head.html' %}
  <style>
   /* Borda laranja para a aba ativa E durante o foco/click */
      .tab-buttons button.active,
      .tab-buttons button:focus,
      .tab-buttons button:focus-visible{
        border: 2px solid #ff8a00 !important;
        outline: none !important;
      }
      /* Suaviza o foco sem ‚Äúflash‚Äù azul do bootstrap */
      .tab-buttons button:focus{
        box-shadow: 0 0 0 .2rem rgba(255,138,0,.25) !important;
      }

      /* Feedback CPF inv√°lido (sem mexer no tema global) */
      .cpf-invalido{
        border-color:#dc3545 !important;
        outline: none;
      }

      /* Mensagens de erro inline */
      .field-error{
        display:block;
        font-size:.85rem;
        color:#dc3545; /* vermelho bootstrap */
        margin-top:.25rem;
      }
      .d-none{display:none !important;}

      /* Bot√µes do rodap√© (Voltar / Cancelar / Salvar) laranja com texto branco */
      .content-wrapper .form-footer .btn{
        background:#ff8a00 !important;
        border-color:#ff8a00 !important;
        color:#fff !important;
      }
      .content-wrapper .form-footer .btn:hover{
        background:#e67a00 !important;
        border-color:#e67a00 !important;
        color:#fff !important;
      }

      /* Estado desabilitado mais escuro para descri√ß√£o de alergia */
      .is-disabled-dark {
        background: #e0e0e0 !important;  /* cinza mais escuro */
        border-color: #bdbdbd !important;
        color: #555 !important;
      }
      .is-disabled-dark::placeholder {
        color: #6b6b6b !important;
      }

      /* Radios em linha (compacto) */
      .radio-group{
        display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      }
      .radio-inline{
        display:flex; align-items:center; gap:6px;
      }

      /* Linha com campos lado a lado em Sa√∫de/Transporte j√° existente */
      .form-row{ display:flex; gap:12px; flex-wrap:wrap; }
      .form-group{ flex:1 1 260px; min-width:220px; }
      .form-group.short-field{ flex:1 1 200px; min-width:160px; }
  </style>
 </head>
 <body>
  {% include 'partials/_nav.html' %}
  <section class="content-wrapper" style="margin-top: 15px;">
   <div class="header-bar">
    Cadastrar Aluno
   </div>
   <div class="tab-buttons" style="padding-top: 1 !important; margin-top: 0 !important;">
    <button data-tab="0" onclick="showTab(0)" type="button">
     Informa√ß√µes Acad√™micas
    </button>
    <button data-tab="1" onclick="showTab(1)" type="button">
     Dados dos Respons√°veis
    </button>
    <button data-tab="2" onclick="showTab(2)" type="button">
     Sa√∫de
    </button>
    <button data-tab="3" onclick="showTab(3)" type="button">
     Transporte
    </button>
    <button data-tab="4" onclick="showTab(4)" type="button">
     Autoriza√ß√µes
    </button>
   </div>
   <form id="formCadastro" method="post">
    {% csrf_token %}
    <!-- TAB 0 -->
    <div class="tab-content">
     <h3>
      Informa√ß√µes Pessoais
     </h3>
     <div class="form-row">
      <div class="form-group">
       <label for="nome">
        Nome
       </label>
       <input id="nome" name="nome" placeholder="Nome completo" type="text"/>
       <small class="field-error d-none" id="nome_error">
       </small>
      </div>
      <div class="form-group">
       <label for="data_nascimento">
        Data de nascimento
       </label>
       <input id="data_nascimento" name="data_nascimento" type="date"/>
       <small class="field-error d-none" id="data_nascimento_error">
       </small>
      </div>
     </div>
     <div class="form-row">
      <div class="form-group short-field">
       <label for="matricula">
        Matr√≠cula
       </label>
       <input disabled="" id="matricula_visivel" type="text" value="{{ matricula }}"/>
       <input id="matricula" name="matricula" type="hidden" value="{{ matricula }}"/>
      </div>
      <div class="form-group short-field">
       <label for="cpf">
        CPF
       </label>
       <input id="cpf" inputmode="numeric" maxlength="14" name="cpf" placeholder="000.000.000-00" type="text"/>
       <small class="field-error d-none" id="cpf_error">
        CPF inv√°lido.
       </small>
      </div>
      <div class="form-group short-field">
       <label for="rg">
        RG
       </label>
       <input id="rg" name="rg" placeholder="RG se houver" type="text"/>
      </div>
     </div>
     <div class="form-row">
      <div class="form-group short-field">
       <label for="sexo">
        Sexo
       </label>
       <select id="sexo" name="sexo">
        <option value="">
         Selecione
        </option>
        <option value="Masculino">
         Masculino
        </option>
        <option value="Feminino">
         Feminino
        </option>
        <option value="Outro">
         Outro
        </option>
       </select>
      </div>
      <div class="form-group short-field">
       <label for="nacionalidade">
        Nacionalidade
       </label>
       <input id="nacionalidade" name="nacionalidade" placeholder="Nacionalidade" type="text"/>
      </div>
      <div class="form-group short-field">
       <label for="naturalidade">
        Naturalidade
       </label>
       <input id="naturalidade" name="naturalidade" placeholder="Cidade/Estado" type="text"/>
      </div>
     </div>
     <div class="form-row">
      <div class="form-group short-field">
       <label for="certidao_numero">
        Certid√£o de nascimento
       </label>
       <input id="certidao_numero" name="certidao_numero" placeholder="N√∫mero" type="text"/>
      </div>
      <div class="form-group short-field">
       <label for="certidao_livro">
        Livro
       </label>
       <input id="certidao_livro" name="certidao_livro" placeholder="Livro" type="text"/>
      </div>
      <div class="form-group short-field">
       <label for="tipo_sanguineo">
        Tipo de sangue e fator RH
       </label>
       <select id="tipo_sanguineo" name="tipo_sanguineo">
        <option value="">
         Selecione
        </option>
        <option value="A+">
         A+
        </option>
        <option value="A-">
         A-
        </option>
        <option value="B+">
         B+
        </option>
        <option value="B-">
         B-
        </option>
        <option value="AB+">
         AB+
        </option>
        <option value="AB-">
         AB-
        </option>
        <option value="O+">
         O+
        </option>
        <option value="O-">
         O-
        </option>
       </select>
      </div>
     </div>
     <!-- Linha com data_ingresso / cor_raca / responsavel_financeiro -->
     <div class="form-row">
      <div class="form-group short-field">
       <label for="data_ingresso">
        Data de ingresso
       </label>
       <input id="data_ingresso" name="data_ingresso" type="date"/>
       <small class="field-error d-none" id="data_ingresso_error">
       </small>
      </div>
      <div class="form-group short-field">
       <label for="cor_raca">
        Cor/Ra√ßa
       </label>
       <select id="cor_raca" name="cor_raca">
        <option value="">
         Selecione
        </option>
        <option value="branca">
         Branca
        </option>
        <option value="preta">
         Preta
        </option>
        <option value="parda">
         Parda
        </option>
        <option value="amarela">
         Amarela
        </option>
        <option value="indigena">
         Ind√≠gena
        </option>
        <option value="nao_informado">
         N√£o informado
        </option>
       </select>
      </div>
      <div class="form-group short-field">
       <label for="responsavel_financeiro">
        Resp. Financeiro
       </label>
       <select id="responsavel_financeiro" name="responsavel_financeiro">
        <option value="">
         Selecione
        </option>
        <option value="pai">
         Pai
        </option>
        <option value="mae">
         M√£e
        </option>
        <option value="outro">
         Outro
        </option>
       </select>
      </div>
     </div>
     <!-- NOVA linha: S√©rie/Ano + Turno + N√≠vel/Modalidade + Turma (do banco) -->
     <div class="form-row">
      <div class="form-group short-field">
       <label for="serie_ano">
        S√©rie/Ano
       </label>
       <input id="serie_ano" name="serie_ano" placeholder="Ex.: 5¬∫ Ano" type="text"/>
      </div>
      <div class="form-group short-field">
       <label for="turno">
        Turno
       </label>
       <select id="turno" name="turno">
        <option value="">
         Selecione
        </option>
        <option value="Matutino">
         Matutino
        </option>
        <option value="Vespertino">
         Vespertino
        </option>
        <option value="Noturno">
         Noturno
        </option>
        <option value="Integral">
         Integral
        </option>
       </select>
      </div>
      <div class="form-group short-field">
       <label for="nivel_modalidade">
        N√≠vel/Modalidade
       </label>
       <select id="nivel_modalidade" name="nivel_modalidade">
        <option value="">
         Selecione
        </option>
        <option value="Infantil">
         Infantil
        </option>
        <option value="Fundamental I">
         Fundamental I
        </option>
        <option value="Fundamental II">
         Fundamental II
        </option>
       </select>
      </div>
      <div class="form-group short-field">
       <label for="turma_id">
        Turma
       </label>
       <select id="turma_id" name="turma_id">
        <option value="">
         Selecione
        </option>
        {% if turmas %}
                              {% for t in turmas %}
        <option value="{{ t.id }}">
         {{ t.nome }}
        </option>
        {% endfor %}
                            {% endif %}
       </select>
      </div>
     </div>
     <!-- Linha com situacao_familiar / forma_acesso / dispensa_ensino_religioso -->
     <div class="form-row">
      <div class="form-group short-field">
       <label for="situacao_familiar">
        Situa√ß√£o familiar
       </label>
       <select id="situacao_familiar" name="situacao_familiar">
        <option value="">
         Selecione
        </option>
        <option value="casados">
         Casados
        </option>
        <option value="separados">
         Separados
        </option>
        <option value="outros">
         Outros
        </option>
       </select>
      </div>
      <div class="form-group short-field">
       <label for="forma_acesso">
        III - Forma de acesso
       </label>
       <select id="forma_acesso" name="forma_acesso">
        <option value="">
         Selecione
        </option>
        <option value="matricula">
         Matr√≠cula
        </option>
        <option value="transferencia">
         Transfer√™ncia
        </option>
       </select>
      </div>
      <div class="form-group short-field">
       <label for="dispensa_ensino_religioso">
        Dispensa Ensino Religioso
       </label>
       <select id="dispensa_ensino_religioso" name="dispensa_ensino_religioso">
        <option value="">
         Selecione
        </option>
        <option value="false">
         N√£o
        </option>
        <option value="true">
         Sim
        </option>
       </select>
      </div>
     </div>
     <h3>
      Endere√ßo
     </h3>
     <div class="form-row">
      <div class="form-group">
       <label for="rua">
        Rua
       </label>
       <input id="rua" name="rua" placeholder="Logradouro" type="text"/>
       <small class="field-error d-none" id="rua_error">
       </small>
      </div>
      <div class="form-group">
       <label for="numero">
        N√∫mero
       </label>
       <input id="numero" name="numero" placeholder="N¬∫" type="text"/>
       <small class="field-error d-none" id="numero_error">
       </small>
      </div>
      <div class="form-group">
       <label for="cep">
        CEP
       </label>
       <input id="cep" name="cep" placeholder="00.000-000" type="text"/>
       <small class="field-error d-none" id="cep_error">
       </small>
      </div>
     </div>
     <div class="form-row">
      <div class="form-group">
       <label for="bairro">
        Bairro
       </label>
       <input id="bairro" name="bairro" type="text"/>
       <small class="field-error d-none" id="bairro_error">
       </small>
      </div>
      <div class="form-group">
       <label for="cidade">
        Cidade
       </label>
       <input id="cidade" name="cidade" type="text"/>
       <small class="field-error d-none" id="cidade_error">
       </small>
      </div>
      <div class="form-group">
       <label for="estado">
        Estado
       </label>
       <input id="estado" name="estado" type="text"/>
       <small class="field-error d-none" id="estado_error">
       </small>
      </div>
     </div>
     <div class="form-row">
      <div class="form-group">
       <label for="email">
        Email
       </label>
       <input id="email" name="email" type="email"/>
       <small class="field-error d-none" id="email_error">
       </small>
      </div>
      <div class="form-group">
       <label for="telefone">
        Telefone
       </label>
       <input id="telefone" name="telefone" type="text"/>
       <small class="field-error d-none" id="telefone_error">
       </small>
      </div>
     </div>
    </div>
    <!-- TAB 1 -->
    <div class="tab-section" style="display:none">
     <h3>
      Dados dos Respons√°veis
     </h3>
     <!-- Gen√©rico (mantido) -->
     <div class="form-row">
      <div class="form-group">
       <label for="responsavel_nome">
        Nome do Respons√°vel
       </label>
       <input id="responsavel_nome" name="responsavel_nome" type="text"/>
       <small class="field-error d-none" id="responsavel_nome_error">
       </small>
      </div>
      <div class="form-group">
       <label for="responsavel_email">
        Email
       </label>
       <input id="responsavel_email" name="responsavel_email" type="email"/>
       <small class="field-error d-none" id="responsavel_email_error">
       </small>
      </div>
     </div>
     <div class="form-row">
      <div class="form-group short-field">
       <label for="responsavel_telefone">
        Telefone
       </label>
       <input id="responsavel_telefone" name="responsavel_telefone" type="text"/>
       <small class="field-error d-none" id="responsavel_telefone_error">
       </small>
      </div>
      <div class="form-group short-field">
       <label for="responsavel_cpf">
        CPF (se houver)
       </label>
       <input id="responsavel_cpf" inputmode="numeric" maxlength="14" placeholder="000.000.000-00" type="text"/>
       <small class="field-error d-none" id="responsavel_cpf_error">
        CPF inv√°lido.
       </small>
      </div>
      <div class="form-group short-field">
       <label for="responsavel_parentesco">
        Parentesco
       </label>
       <input id="responsavel_parentesco" placeholder="Pai, M√£e, ..." type="text"/>
       <small class="field-error d-none" id="responsavel_parentesco_error">
       </small>
      </div>
     </div>
     <!-- Pai / M√£e no mesmo padr√£o -->
     <h4 style="font-size:1rem;margin:.5rem 0;">
      Pai
     </h4>
     <div class="form-row">
      <div class="form-group">
       <label for="pai_nome">
        Nome
       </label>
       <input id="pai_nome" type="text"/>
       <small class="field-error d-none" id="pai_nome_error">
       </small>
      </div>
      <div class="form-group short-field">
       <label for="pai_cpf">
        CPF
       </label>
       <input id="pai_cpf" inputmode="numeric" maxlength="14" placeholder="000.000.000-00" type="text"/>
       <small class="field-error d-none" id="pai_cpf_error">
        CPF inv√°lido.
       </small>
      </div>
      <div class="form-group short-field">
       <label for="pai_identidade">
        Identidade
       </label>
       <input id="pai_identidade" type="text"/>
       <small class="field-error d-none" id="pai_identidade_error">
       </small>
      </div>
     </div>
     <div class="form-row">
      <div class="form-group short-field">
       <label for="pai_escolaridade">
        Escolaridade
       </label>
       <input id="pai_escolaridade" type="text"/>
       <small class="field-error d-none" id="pai_escolaridade_error">
       </small>
      </div>
      <div class="form-group short-field">
       <label for="pai_profissao">
        Profiss√£o
       </label>
       <input id="pai_profissao" type="text"/>
       <small class="field-error d-none" id="pai_profissao_error">
       </small>
      </div>
      <div class="form-group short-field">
       <label for="pai_telefone">
        Telefone
       </label>
       <input id="pai_telefone" type="text"/>
       <small class="field-error d-none" id="pai_telefone_error">
       </small>
      </div>
      <div class="form-group short-field">
       <label for="pai_email">
        Email
       </label>
       <input id="pai_email" type="email"/>
       <small class="field-error d-none" id="pai_email_error">
       </small>
      </div>
     </div>
     <h4 style="font-size:1rem;margin:.5rem 0;">
      M√£e
     </h4>
     <div class="form-row">
      <div class="form-group">
       <label for="mae_nome">
        Nome
       </label>
       <input id="mae_nome" type="text"/>
       <small class="field-error d-none" id="mae_nome_error">
       </small>
      </div>
      <div class="form-group short-field">
       <label for="mae_cpf">
        CPF
       </label>
       <input id="mae_cpf" inputmode="numeric" maxlength="14" placeholder="000.000.000-00" type="text"/>
       <small class="field-error d-none" id="mae_cpf_error">
        CPF inv√°lido.
       </small>
      </div>
      <div class="form-group short-field">
       <label for="mae_identidade">
        Identidade
       </label>
       <input id="mae_identidade" type="text"/>
       <small class="field-error d-none" id="mae_identidade_error">
       </small>
      </div>
     </div>
     <div class="form-row">
      <div class="form-group short-field">
       <label for="mae_escolaridade">
        Escolaridade
       </label>
       <input id="mae_escolaridade" type="text"/>
       <small class="field-error d-none" id="mae_escolaridade_error">
       </small>
      </div>
      <div class="form-group short-field">
       <label for="mae_profissao">
        Profiss√£o
       </label>
       <input id="mae_profissao" type="text"/>
       <small class="field-error d-none" id="mae_profissao_error">
       </small>
      </div>
      <div class="form-group short-field">
       <label for="mae_telefone">
        Telefone
       </label>
       <input id="mae_telefone" type="text"/>
       <small class="field-error d-none" id="mae_telefone_error">
       </small>
      </div>
      <div class="form-group short-field">
       <label for="mae_email">
        Email
       </label>
       <input id="mae_email" type="email"/>
       <small class="field-error d-none" id="mae_email_error">
       </small>
      </div>
     </div>
    </div>
    <!-- TAB 2 -->
    <div class="tab-section" style="display:none">
     <h3>
      Sa√∫de e Necessidades Especiais
     </h3>
     <div class="form-row">
      <!-- Possui alergia? Sim/N√£o -->
      <div class="form-group short-field">
       <label>
        Possui alergia?
       </label>
       <div class="radio-group">
        <label class="radio-inline">
         <input id="alergia_sim" name="possui_alergia" type="radio" value="sim"/>
         Sim
        </label>
        <label class="radio-inline">
         <input checked="" id="alergia_nao" name="possui_alergia" type="radio" value="nao"/>
         N√£o
        </label>
       </div>
       <small class="field-error d-none" id="possui_alergia_error">
       </small>
      </div>
      <!-- Descri√ß√£o (habilita s√≥ se Sim) -->
      <div class="form-group">
       <label for="descricao_alergia">
        Descri√ß√£o da(s) alergia(s)
       </label>
       <input class="is-disabled-dark" disabled="" id="descricao_alergia" name="descricao_alergia" placeholder="Descreva a(s) alergia(s)" type="text"/>
       <small class="field-error d-none" id="descricao_alergia_error">
       </small>
      </div>
      <!-- Restri√ß√µes alimentares (texto livre) -->
      <div class="form-group">
       <label for="restricoes">
        Restri√ß√µes alimentares
       </label>
       <input id="restricoes" name="restricoes" placeholder="Ex.: intoler√¢ncia √† lactose" type="text"/>
       <small class="field-error d-none" id="restricoes_error">
       </small>
      </div>
     </div>
     <div class="form-row">
      <!-- Necessidades especiais (simples) -->
      <div class="form-group">
       <label for="necessidades">
        Necessidades especiais
       </label>
       <input id="necessidades" name="necessidades" placeholder="Descreva, se houver" type="text"/>
       <small class="field-error d-none" id="necessidades_error">
       </small>
      </div>
      <!-- Usa medica√ß√£o? (opcional) -->
      <div class="form-group short-field">
       <label for="usa_medicacao">
        Usa medica√ß√£o?
       </label>
       <select id="usa_medicacao" name="usa_medicacao">
        <option value="">
         Selecione
        </option>
        <option value="sim">
         Sim
        </option>
        <option value="nao">
         N√£o
        </option>
       </select>
       <small class="field-error d-none" id="usa_medicacao_error">
       </small>
      </div>
      <div class="form-group">
       <label for="quais_medicacoes">
        Quais medica√ß√µes?
       </label>
       <input id="quais_medicacoes" name="quais_medicacoes" placeholder="Liste as medica√ß√µes, se houver" type="text"/>
       <small class="field-error d-none" id="quais_medicacoes_error">
       </small>
      </div>
     </div>
    </div>
    <!-- TAB 3 -->
    <div class="tab-section" style="display:none">
     <h3>
      Transporte Escolar
     </h3>
     <div class="form-row">
      <div class="form-group short-field">
       <label for="utiliza_transporte">
        Utiliza transporte escolar?
       </label>
       <select id="utiliza_transporte" name="utiliza_transporte">
        <option value="">
         Selecione
        </option>
        <option value="sim">
         Sim
        </option>
        <option value="nao">
         N√£o
        </option>
       </select>
       <small class="field-error d-none" id="utiliza_transporte_error">
       </small>
      </div>
      <div class="form-group short-field">
       <label for="usa_transporte_publico">
        Usa transporte p√∫blico?
       </label>
       <select id="usa_transporte_publico" name="usa_transporte_publico">
        <option value="">
         Selecione
        </option>
        <option value="sim">
         Sim
        </option>
        <option value="nao">
         N√£o
        </option>
       </select>
       <small class="field-error d-none" id="usa_transporte_publico_error">
       </small>
      </div>
      <div class="form-group">
       <label for="ponto_onibus">
        Trajeto/Ponto de √¥nibus
       </label>
       <input id="ponto_onibus" name="ponto_onibus" placeholder="Ex.: Linha Centro ‚Ä¢ Ponto da Pra√ßa" type="text"/>
       <small class="field-error d-none" id="ponto_onibus_error">
       </small>
      </div>
     </div>
    </div>
    <!-- TAB 4 -->
    <div class="tab-section" style="display:none">
     <h3>
      Autoriza√ß√µes
     </h3>
     <div class="form-row">
      <div class="form-group short-field">
       <label for="pode_sair_sozinho">
        Pode sair sozinho?
       </label>
       <select id="pode_sair_sozinho" name="pode_sair_sozinho">
        <option value="">
         Selecione
        </option>
        <option value="sim">
         Sim
        </option>
        <option value="nao">
         N√£o
        </option>
       </select>
       <small class="field-error d-none" id="pode_sair_sozinho_error">
       </small>
      </div>
      <div class="form-group">
       <label for="autorizados_buscar">
        Pessoas autorizadas a buscar
       </label>
       <input id="autorizados_buscar" name="autorizados_buscar" placeholder="Nome(s) e rela√ß√£o" type="text"/>
       <small class="field-error d-none" id="autorizados_buscar_error">
       </small>
      </div>
      <!-- Bolsa Fam√≠lia -->
      <div class="form-group short-field">
       <label for="bolsa_familia">
        Recebe Bolsa Fam√≠lia?
       </label>
       <select id="bolsa_familia" name="bolsa_familia">
        <option value="">
         Selecione
        </option>
        <option value="true">
         Sim
        </option>
        <option value="false">
         N√£o
        </option>
       </select>
       <small class="field-error d-none" id="bolsa_familia_error">
       </small>
      </div>
     </div>
    </div>
    <div class="form-footer" style="display:flex; gap:8px; flex-wrap:wrap;">
     <button class="btn btn-secondary" onclick="goBack()" type="button">
      Voltar
     </button>
     <button class="btn btn-light" onclick="cancelForm()" type="button">
      Cancelar
     </button>
     <button class="btn btn-primary" id="submitButton" type="button">
      Salvar
     </button>
    </div>
   </form>
  </section>
  <footer>
   {% include 'partials/_footer.html' %}
  </footer>
  <script>
   // ===== Tabs =====
        function showTab(index) {
            const tabs = [
                document.querySelector('.tab-content'),
                ...document.querySelectorAll('.tab-section')
            ];
            const btns = document.querySelectorAll('.tab-buttons [data-tab]');

            tabs.forEach((tab, i) => {
                if (!tab) return;
                tab.style.display = (i === index) ? 'block' : 'none';
            });
            btns.forEach((b, i)=> b.classList.toggle('active', i===index));

            const activeBtn = document.querySelector(`.tab-buttons [data-tab="${index}"]`);
            if (activeBtn) activeBtn.focus({preventScroll:true});
        }
        showTab(0);

        function goBack() { window.history.back(); }
        function cancelForm() { window.location.href = document.referrer || '/'; }

        function getCsrfToken() {
            const input = document.querySelector('input[name="csrfmiddlewaretoken"]');
            return input ? input.value : '';
        }

        // ===== helpers de erro inline =====
        function showFieldError(id, msg){
          const el = document.getElementById(id + '_error');
          if (el){ el.textContent = msg; el.classList.remove('d-none'); }
        }
        function clearFieldError(id){
          const el = document.getElementById(id + '_error');
          if (el){ el.textContent = ''; el.classList.add('d-none'); }
        }

        // ===== M√°scara e valida√ß√£o de CPF =====
        function onlyDigits(v){ return (v||'').replace(/\D/g,''); }
        function maskCPF(v){
          v = onlyDigits(v).slice(0,11);
          if (v.length > 9) return v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
          if (v.length > 6) return v.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
          if (v.length > 3) return v.replace(/(\d{3})(\d{0,3})/, '$1.$2');
          return v;
        }
        function cpfValido(cpf){
          cpf = onlyDigits(cpf);
          if (cpf.length !== 11) return false;
          if (/^(\d)\1{10}$/.test(cpf)) return false;
          let soma=0; for (let i=0;i<9;i++) soma += parseInt(cpf[i])*(10-i);
          let d1 = (soma*10)%11; if (d1===10) d1=0; if (d1!==parseInt(cpf[9])) return false;
          soma=0; for (let i=0;i<10;i++) soma += parseInt(cpf[i])*(11-i);
          let d2 = (soma*10)%11; if (d2===10) d2=0; return d2===parseInt(cpf[10]);
        }
        function wireCPF(input, errorId){
          if(!input) return;
          input.addEventListener('input', ()=>{
            input.value = maskCPF(input.value);
            input.classList.remove('cpf-invalido');
            if (errorId) clearFieldError(errorId);
          });
          input.addEventListener('blur', ()=>{
            const v = input.value.trim();
            const ok = v==='' ? true : cpfValido(v);
            input.classList.toggle('cpf-invalido', !ok);
            input.setCustomValidity(ok ? '' : 'CPF inv√°lido');
            if (!ok && errorId) showFieldError(errorId, 'CPF inv√°lido.');
            if (ok && errorId) clearFieldError(errorId);
          });
        }

        // ===== Valida√ß√µes de data =====
        function parseISODate(value){
          if (!value) return null;
          const d = new Date(value + 'T00:00:00');
          return isNaN(d.getTime()) ? null : d;
        }
        function isFuture(d){
          const today = new Date();
          today.setHours(0,0,0,0);
          return d.getTime() > today.getTime();
        }
        function validateDataNascimento(){
          const el = document.getElementById('data_nascimento');
          const v = el.value;
          clearFieldError('data_nascimento');
          if (!v) return true;
          const d = parseISODate(v);
          if (!d){
            showFieldError('data_nascimento','Data de nascimento inv√°lida.');
            return false;
          }
          const min = new Date('1900-01-01T00:00:00');
          if (d < min){
            showFieldError('data_nascimento','Data de nascimento n√£o pode ser anterior a 01/01/1900.');
            return false;
          }
          if (isFuture(d)){
            showFieldError('data_nascimento','Data de nascimento n√£o pode ser no futuro.');
            return false;
          }
          return true;
        }
        function validateDataIngresso(){
          const el = document.getElementById('data_ingresso');
          const v = el.value;
          clearFieldError('data_ingresso');
          if (!v) return true; // opcional
          const d = parseISODate(v);
          if (!d){
            showFieldError('data_ingresso','Data de ingresso inv√°lida.');
            return false;
          }
          if (isFuture(d)){
            showFieldError('data_ingresso','Data de ingresso n√£o pode ser no futuro.');
            return false;
          }
          const nasc = parseISODate(document.getElementById('data_nascimento').value);
          if (nasc && d < nasc){
            showFieldError('data_ingresso','Data de ingresso n√£o pode ser anterior √† data de nascimento.');
            return false;
          }
          return true;
        }

        // ===== Alergia: habilita/desabilita descri√ß√£o + cor escura quando desabilitado =====
        function setAlergiaState(has){
          const desc = document.getElementById('descricao_alergia');
          if (!desc) return;
          desc.disabled = !has;
          desc.classList.toggle('is-disabled-dark', !has);
          if (!has) {
            // Se desejar limpar quando marcar "N√£o"
            // desc.value = '';
          }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // CPF + mensagens inline
            wireCPF(document.getElementById('cpf'), 'cpf');
            wireCPF(document.getElementById('responsavel_cpf'), 'responsavel_cpf');
            wireCPF(document.getElementById('pai_cpf'), 'pai_cpf');
            wireCPF(document.getElementById('mae_cpf'), 'mae_cpf');

            // Datas no blur
            const dn = document.getElementById('data_nascimento');
            const di = document.getElementById('data_ingresso');
            if (dn) dn.addEventListener('blur', validateDataNascimento);
            if (di) di.addEventListener('blur', validateDataIngresso);

            // Radios de alergia
            const rSim = document.getElementById('alergia_sim');
            const rNao = document.getElementById('alergia_nao');
            if (rSim) rSim.addEventListener('change', ()=> setAlergiaState(true));
            if (rNao) rNao.addEventListener('change', ()=> setAlergiaState(false));
            // estado inicial
            setAlergiaState(rSim?.checked === true);

            const btn = document.getElementById('submitButton');
            btn.addEventListener('click', function (event) {
                event.preventDefault();

                // Limpa erros antigos
                ['cpf','responsavel_cpf','pai_cpf','mae_cpf','data_nascimento','data_ingresso','nome','rua','numero','cep','bairro','cidade','estado','email','telefone'].forEach(clearFieldError);

                const erros = [];

                // Valida CPFs
                const cpfInputs = [
                  {id:'cpf', label:'CPF do aluno'},
                  {id:'responsavel_cpf', label:'CPF do respons√°vel'},
                  {id:'pai_cpf', label:'CPF do pai'},
                  {id:'mae_cpf', label:'CPF da m√£e'}
                ];
                for (const item of cpfInputs){
                  const el = document.getElementById(item.id);
                  if (!el) continue;
                  const v = el.value.trim();
                  if (v && !cpfValido(v)){
                    el.classList.add('cpf-invalido');
                    el.reportValidity();
                    showFieldError(item.id, `${item.label} inv√°lido.`);
                    erros.push(`${item.label} inv√°lido.`);
                  }
                }

                // Datas
                if (!validateDataNascimento()) erros.push('Corrija a Data de Nascimento.');
                if (!validateDataIngresso()) erros.push('Corrija a Data de Ingresso.');

                // Campos obrigat√≥rios principais
                function required(id, label){
                  const el = document.getElementById(id);
                  const val = (el && el.value || '').trim();
                  if (!val){
                    showFieldError(id, `O campo "${label}" √© obrigat√≥rio.`);
                    erros.push(`Campo obrigat√≥rio: ${label}.`);
                    return false;
                  }
                  return true;
                }
                required('nome','Nome');
                required('data_nascimento','Data de nascimento');
                required('cpf','CPF');
                required('email','Email');
                required('telefone','Telefone');
                required('rua','Rua');
                required('numero','N√∫mero');
                required('bairro','Bairro');
                required('cidade','Cidade');
                required('estado','Estado');

                if (erros.length){
                  alert('‚ö†Ô∏è Corrija os seguintes itens antes de salvar:\n\n‚Ä¢ ' + erros.join('\n‚Ä¢ '));
                  const firstErr = document.querySelector('.field-error:not(.d-none)') ||
                                   document.querySelector('.cpf-invalido');
                  if (firstErr){
                    const target = firstErr.id?.endsWith('_error')
                      ? document.getElementById(firstErr.id.replace('_error',''))
                      : firstErr;
                    if (target && typeof target.focus === 'function') target.focus();
                  }
                  return;
                }

                // L√™ radios de alergia
                const possuiAlergia = document.getElementById('alergia_sim')?.checked === true;

                const dados = {
                    // ===== B√°sico
                    matricula: (document.getElementById('matricula').value || '').trim(),
                    nome: (document.getElementById('nome').value || '').trim(),
                    data_nascimento: (document.getElementById('data_nascimento').value || '').trim(),
                    cpf: (document.getElementById('cpf').value || '').trim(),
                    rg: (document.getElementById('rg').value || '').trim(),
                    sexo: (document.getElementById('sexo').value || '').trim(),
                    nacionalidade: (document.getElementById('nacionalidade').value || '').trim(),
                    naturalidade: (document.getElementById('naturalidade').value || '').trim(),
                    certidao_numero: (document.getElementById('certidao_numero').value || '').trim(),
                    certidao_livro: (document.getElementById('certidao_livro').value || '').trim(),
                    tipo_sanguineo: (document.getElementById('tipo_sanguineo').value || '').trim(),
                    rua: (document.getElementById('rua').value || '').trim(),
                    numero: (document.getElementById('numero').value || '').trim(),
                    cep: (document.getElementById('cep').value || '').trim(),
                    bairro: (document.getElementById('bairro').value || '').trim(),
                    cidade: (document.getElementById('cidade').value || '').trim(),
                    estado: (document.getElementById('estado').value || '').trim(),
                    email: (document.getElementById('email').value || '').trim(),
                    telefone: (document.getElementById('telefone').value || '').trim(),

                    // ===== Novos do aluno (opcionais)
                    data_ingresso: (document.getElementById('data_ingresso').value || '').trim(),
                    cor_raca: (document.getElementById('cor_raca').value || '').trim(),
                    responsavel_financeiro: (document.getElementById('responsavel_financeiro').value || '').trim(),
                    situacao_familiar: (document.getElementById('situacao_familiar').value || '').trim(),
                    forma_acesso: (document.getElementById('forma_acesso').value || '').trim(),
                    dispensa_ensino_religioso: (document.getElementById('dispensa_ensino_religioso').value === 'true'),

                    /* ===== NOVOS CAMPOS pedidos ===== */
                    serie_ano: (document.getElementById('serie_ano').value || '').trim(),
                    turno: (document.getElementById('turno').value || '').trim(),
                    nivel_modalidade: (document.getElementById('nivel_modalidade').value || '').trim(),
                    turma_id: (document.getElementById('turma_id').value || '').trim(),

                    // ===== Respons√°vel gen√©rico
                    responsavel_nome: (document.getElementById('responsavel_nome').value || '').trim(),
                    responsavel_cpf: document.getElementById('responsavel_cpf') ? document.getElementById('responsavel_cpf').value.trim() : '',
                    responsavel_parentesco: document.getElementById('responsavel_parentesco') ? document.getElementById('responsavel_parentesco').value.trim() : '',
                    responsavel_telefone: (document.getElementById('responsavel_telefone').value || '').trim(),
                    responsavel_email: (document.getElementById('responsavel_email').value || '').trim(),

                    // ===== Pai/M√£e (opcionais)
                    pai_nome: (document.getElementById('pai_nome').value || '').trim(),
                    pai_cpf: (document.getElementById('pai_cpf').value || '').trim(),
                    pai_identidade: (document.getElementById('pai_identidade').value || '').trim(),
                    pai_escolaridade: (document.getElementById('pai_escolaridade').value || '').trim(),
                    pai_profissao: (document.getElementById('pai_profissao').value || '').trim(),
                    pai_telefone: (document.getElementById('pai_telefone').value || '').trim(),
                    pai_email: (document.getElementById('pai_email').value || '').trim(),

                    mae_nome: (document.getElementById('mae_nome').value || '').trim(),
                    mae_cpf: (document.getElementById('mae_cpf').value || '').trim(),
                    mae_identidade: (document.getElementById('mae_identidade').value || '').trim(),
                    mae_escolaridade: (document.getElementById('mae_escolaridade').value || '').trim(),
                    mae_profissao: (document.getElementById('mae_profissao').value || '').trim(),
                    mae_telefone: (document.getElementById('mae_telefone').value || '').trim(),
                    mae_email: (document.getElementById('mae_email').value || '').trim(),

                    // ===== Sa√∫de (atualizado p/ Sim/N√£o + descri√ß√£o)
                    possui_necessidade_especial: (document.getElementById('necessidades').value || '').trim() !== '',
                    descricao_necessidade: (document.getElementById('necessidades').value || '').trim(),
                    usa_medicacao: (document.getElementById('usa_medicacao').value === 'sim'),
                    quais_medicacoes: (document.getElementById('quais_medicacoes').value || '').trim(),
                    possui_alergia: possuiAlergia,
                    descricao_alergia: (document.getElementById('descricao_alergia').value || '').trim(),
                    restricoes_alimentares: (document.getElementById('restricoes').value || '').trim(),

                    // ===== Transporte
                    usa_transporte_escolar: (document.getElementById('utiliza_transporte').value === 'sim'),
                    trajeto: (document.getElementById('ponto_onibus').value || '').trim(),
                    usa_transporte_publico: (document.getElementById('usa_transporte_publico')?.value === 'sim'),

                    // ===== Autoriza√ß√µes
                    autorizacao_saida_sozinho: (document.getElementById('pode_sair_sozinho').value === 'sim'),
                    autorizacao_fotos_eventos: false,
                    pessoa_autorizada_buscar: (document.getElementById('autorizados_buscar').value || '').trim(),

                    // ===== Bolsa Fam√≠lia
                    bolsa_familia: (document.getElementById('bolsa_familia').value === 'true')
                };

                console.log("üì¶ Enviando:", dados);

                fetch('/salvar_aluno/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(dados)
                })
                .then(async (res) => {
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok) {
                        const msg = data.mensagem || data.error || `Erro HTTP ${res.status}`;
                        alert("‚ùå Erro ao salvar:\n\n" + msg);
                        throw new Error(msg);
                    }
                    return data;
                })
                .then((data) => {
                    if (data.status === 'sucesso') {
                        const alunoId = data.aluno_id;
                        const container = document.createElement('div');
                        container.className = 'alert alert-success';
                        container.style.marginTop = '12px';
                        container.innerHTML = `
                           ‚úÖ Aluno cadastrado com sucesso!
                        <a class="btn btn-sm btn-primary ml-2"
                        href="${"{% url 'aluno_requerimento' 0 %}".replace('/0/', `/${alunoId}/`)}"
                        target="_blank" rel="noopener">
                        Imprimir cadastro (PDF)
                        </a>
                        `;
                        const form = document.getElementById('formCadastro');
                        form.parentNode.insertBefore(container, form.nextSibling);
                        document.getElementById('submitButton').disabled = true;
                    } else {
                        const msg = data.mensagem || "N√£o foi poss√≠vel cadastrar.";
                        alert("‚ùå Erro:\n\n" + msg);
                        console.error("Erro no backend:", data);
                    }
                })
                .catch((error) => {
                    console.error("üö® Erro na requisi√ß√£o:", error);
                });
            });
        });
  </script>
 </body>
</html>
