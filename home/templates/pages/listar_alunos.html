{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    {% include 'partials/_head.html' %}

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!-- Fuse.js -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

    <style>
        body {
            background: #f7f7f7;
        }

        /* T√çTULO */
        .titulo-pagina {
            background: #6c757d;
            color: #fff;
            font-weight: bold;
            font-size: 1.4rem;
            padding: .85rem 1.2rem;
            border-radius: 6px;
            margin-bottom: 1.4rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* DASHBOARD */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media(max-width:992px) {
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media(max-width:576px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }

        .dash-card {
            background: #fff;
            padding: 1.2rem 1.3rem;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #fab982;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .dash-card .icone-card {
            font-size: 2rem;
            color: #fab982;
            margin-bottom: .5rem;
        }

        .dash-card h4 {
            font-size: 1rem;
            margin-bottom: .35rem;
            color: #444;
        }

        .dash-card .valor {
            font-size: 1.7rem;
            font-weight: bold;
            color: #444;
        }

        /* =============================== */
        /* CONTROLES ‚Äî 100% POR LINHA     */
        /* =============================== */
        .list-controls {
            display: flex;
            flex-direction: column;
            gap: .75rem;
            margin-bottom: 1.4rem;
        }

        .list-controls input,
        .list-controls select {
            width: 100% !important;
            height: 44px;
            border: 2px solid #fab982 !important;
            border-radius: 6px;
        }

        /* autocomplete alinhado */
        #autocompleteBox {
            border: 2px solid #fab982;
            border-top: none;
            position: absolute;
            background: #fff;
            z-index: 999;
            width: 100%;
            display: none;
            max-height: 220px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
            top: 44px;
        }

        #autocompleteBox div {
            padding: 8px 10px;
            cursor: pointer;
        }

        #autocompleteBox div:hover {
            background: #f5f5f5;
        }

        /* TABELA */
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #fab982;
        }

        table thead th {
            padding: 12px;
            background: #fef6ef;
            border-bottom: 2px solid #fab982;
            font-weight: 600;
            cursor: pointer;
            color: #444;
        }

        table tbody td {
            padding: 10px 12px;
        }

        table tbody tr:hover {
            background: #fafafa;
        }

        mark {
            background: #ffe4b3;
            padding: 0 2px;
        }
    </style>
</head>

<body>

{% include 'partials/_nav.html' %}

<section class="py-5">
    <div class="container">

        <div class="titulo-pagina">Lista de Alunos</div>

        <!-- CARDS -->
        <div class="dashboard-cards">

            <div class="dash-card">
                <div class="icone-card"><i class="bi bi-people-fill"></i></div>
                <h4>Total</h4>
                <div class="valor" id="cardTotal">0</div>
            </div>

            <div class="dash-card">
                <div class="icone-card"><i class="bi bi-person-check-fill"></i></div>
                <h4>Ativos</h4>
                <div class="valor" id="cardAtivos">0</div>
            </div>

            <div class="dash-card">
                <div class="icone-card"><i class="bi bi-person-x-fill"></i></div>
                <h4>Inativos</h4>
                <div class="valor" id="cardInativos">0</div>
            </div>

            <div class="dash-card">
                <div class="icone-card"><i class="bi bi-calendar-event-fill"></i></div>
                <h4>Aniversariantes do m√™s</h4>
                <div class="valor" id="cardNivers">0</div>
            </div>
        </div>
            <!-- CONTROLES 100% LARGURA, 1 POR LINHA -->
            <div class="list-controls">

                <div class="control-row">
                    <input id="filtroAluno" class="form-control"
                        placeholder="üîç Buscar aluno, CPF, matr√≠cula, respons√°vel...">
                    <div id="autocompleteBox"></div>
                </div>

                <div class="control-row">
                    <select id="filtroStatus" class="custom-select">
                        <option value="">Status: todos</option>
                        <option value="ativo">Ativos</option>
                        <option value="inativo">Inativos</option>
                    </select>
                </div>

                <div class="control-row">
                    <select id="filtroTurma" class="custom-select">
                        <option value="">Turma: todas</option>
                    </select>
                </div>

                <div class="control-row">
                    <select id="pageSize" class="custom-select">
                        <option value="10">Exibir 10</option>
                        <option value="25" selected>Exibir 25</option>
                        <option value="50">Exibir 50</option>
                        <option value="100">Exibir 100</option>
                    </select>
                </div>

                <div class="control-row">
                    <button id="clearFilters" class="btn btn-secondary btn-sm">
                        Limpar filtros
                    </button>
                </div>

            </div>

            <!-- TABELA -->
            <table id="tabelaAlunos">
                <thead>
                    <tr>
                        <th data-sort="matricula">Matr√≠cula</th>
                        <th data-sort="turma">Turma</th>
                        <th data-sort="nome">Nome</th>
                        <th data-sort="responsaveis">Respons√°veis</th>
                        <th data-sort="telefone">Telefone</th>
                        <th data-sort="nee">NEE</th>
                        <th data-sort="ativo">Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>

                <tbody id="tabelaAlunosBody">
                    <script id="alunos-data" type="application/json">
                        {{ alunos_json|safe }}
                    </script>
                </tbody>
            </table>

            <!-- PAGINA√á√ÉO -->
            <div class="pagination-bar mt-3 d-flex justify-content-between align-items-center">
                <div id="resultsInfo">Mostrando 0‚Äì0 de 0</div>
                <ul class="pagination mb-0">
                    <li class="page-item"><button id="firstPage" class="page-link">¬´</button></li>
                    <li class="page-item"><button id="prevPage" class="page-link">‚Äπ</button></li>
                    <li class="page-item disabled"><span id="pageIndicator" class="page-link">1 / 1</span></li>
                    <li class="page-item"><button id="nextPage" class="page-link">‚Ä∫</button></li>
                    <li class="page-item"><button id="lastPage" class="page-link">¬ª</button></li>
                </ul>
            </div>

        </div>
    </section>

    {% include "partials/modal_editar_aluno.html" %}

<!-- =====================================================
   JAVASCRIPT COMPLETO ‚Äî NADA ALTERADO NO FUNCIONAL
===================================================== -->
<script>
/* =======================================================
   1. CARREGAR DADOS
======================================================= */
const alunos = JSON.parse(document.getElementById("alunos-data").textContent);
const userRole = "{{ user.role }}";
const turmasPermitidas = JSON.parse(`{{ turmas_usuario|safe }}`);

/* =======================================================
   2. FUN√á√ïES AUXILIARES
======================================================= */
function normaliza(t) {
    return (t || "")
        .toString()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase();
}

function turmaLabel(a) {
    if (!a.turma) return "";
    return a.turma.nome || a.turma.sigla || "";
}

function highlight(text, term) {
    if (!term) return text;
    const regex = new RegExp(`(${term})`, "gi");
    return text.replace(regex, `<mark>$1</mark>`);
}

/* =======================================================
   3. PERMISS√ïES
======================================================= */
function alunosPermitidos() {
    if (["diretor", "coordenador", "secretaria"].includes(userRole))
        return alunos;

    if (userRole === "professor") {
        return alunos.filter(a => turmasPermitidas.includes(turmaLabel(a)));
    }

    return alunos;
}

/* =======================================================
   4. FUZZY SEARCH + AUTOCOMPLETE
======================================================= */
const fuse = new Fuse(alunos, {
    includeScore: true,
    threshold: 0.29,
    ignoreLocation: true,
    keys: [
        "nome",
        "cpf",
        "matricula",
        "responsaveis.nome",
        "responsaveis.cpf",
        "responsaveis.telefone",
        "cidade",
        "bairro",
        "turma.nome"
    ]
});

let searchTerm = "";
const autoBox = document.getElementById("autocompleteBox");

function showSugestoes(lista, termo) {
    if (!termo || lista.length === 0) {
        autoBox.style.display = "none";
        return;
    }

    autoBox.innerHTML = "";
    lista.slice(0, 6).forEach(a => {
        const div = document.createElement("div");
        div.innerHTML = highlight(a.nome, termo);
        div.onclick = () => {
            document.getElementById("filtroAluno").value = a.nome;
            searchTerm = a.nome;
            autoBox.style.display = "none";
            renderizarTabela(1);
        };
        autoBox.appendChild(div);
    });

    autoBox.style.display = "block";
}

document.addEventListener("click", function (event) {
    if (!event.target.closest("#autocompleteBox") &&
        !event.target.closest("#filtroAluno")) {
        autoBox.style.display = "none";
    }
});

function aplicarBusca() {
    const termo = searchTerm.trim().toLowerCase();

    if (!termo) {
        autoBox.style.display = "none";
        return alunosPermitidos();
    }

    const resultado = fuse.search(termo).map(r => r.item);
    showSugestoes(resultado, termo);
    return resultado;
}

/* =======================================================
   5. FILTROS SIMPLES
======================================================= */
let statusFilter = "";
let turmaFilter = "";

function filtrarSimples(lista) {
    return lista.filter(a => {
        if (statusFilter === "ativo" && !a.ativo) return false;
        if (statusFilter === "inativo" && a.ativo) return false;
        if (turmaFilter && turmaLabel(a) !== turmaFilter) return false;
        return true;
    });
}

/* =======================================================
   6. ORDENAR
======================================================= */
let sortKey = "";
let sortDir = "asc";

function ordenarLista(lista) {
    if (!sortKey) return lista;

    return lista.slice().sort((a, b) => {
        let av = sortKey === "turma" ? turmaLabel(a) : a[sortKey];
        let bv = sortKey === "turma" ? turmaLabel(b) : b[sortKey];

        av = normaliza(av);
        bv = normaliza(bv);

        if (av < bv) return sortDir === "asc" ? -1 : 1;
        if (av > bv) return sortDir === "asc" ? 1 : -1;
        return 0;
    });
}

/* =======================================================
   7. PAGINA√á√ÉO
======================================================= */
let pageSize = 25;
let currentPage = 1;

/* =======================================================
   8. ATUALIZAR CARDS
======================================================= */
function atualizarCards(listaTotal) {
    const total = listaTotal.length;
    const ativos = listaTotal.filter(a => a.ativo).length;
    const inativos = total - ativos;

    const mes = new Date().getMonth();
    const aniversario = listaTotal.filter(a => {
        if (!a.data_nascimento) return false;
        return new Date(a.data_nascimento).getMonth() === mes;
    }).length;

    document.getElementById("cardTotal").textContent = total;
    document.getElementById("cardAtivos").textContent = ativos;
    document.getElementById("cardInativos").textContent = inativos;
    document.getElementById("cardNivers").textContent = aniversario;
}

/* =======================================================
   9. RENDERIZAR TABELA
======================================================= */
function renderizarTabela(pagina = 1) {

    let lista = aplicarBusca();
    const permitidos = alunosPermitidos();

    lista = lista.filter(a => permitidos.includes(a));
    lista = filtrarSimples(lista);
    lista = ordenarLista(lista);

    atualizarCards(alunos);

    const total = lista.length;
    const totalPaginas = Math.max(1, Math.ceil(total / pageSize));

    currentPage = Math.min(Math.max(1, pagina), totalPaginas);

    const ini = (currentPage - 1) * pageSize;
    const fim = ini + pageSize;

    const tbody = document.getElementById("tabelaAlunosBody");
    tbody.innerHTML = "";

    lista.slice(ini, fim).forEach(a => {
        const resp = a.responsaveis?.length ? a.responsaveis[0].nome : "";
        const termo = searchTerm.toLowerCase();

        tbody.insertAdjacentHTML("beforeend", `
            <tr>
                <td>${highlight(a.matricula, termo)}</td>
                <td>${highlight(turmaLabel(a), termo)}</td>
                <td>${highlight(a.nome, termo)}</td>
                <td>${highlight(resp, termo)}</td>
                <td>${highlight(a.responsaveis?.[0]?.telefone || "", termo)}</td>
                <td>${a.possui_necessidade_especial ? "üß©" : "‚Äì"}</td>
                <td>
                    ${a.ativo
                        ? "<span class='badge badge-success'>Ativo</span>"
                        : "<span class='badge badge-secondary'>Inativo</span>"
                    }
                </td>
                <td style="white-space:nowrap;">
                    <button class="btn btn-info btn-sm mr-1" onclick="editarPorId(${a.id})">Editar</button>
                    <a href="/alunos/${a.id}/pdf/" target="_blank" class="btn btn-secondary btn-sm">
                        Imprimir
                    </a>
                </td>
            </tr>
        `);
    });

    document.getElementById("resultsInfo").textContent =
        total ? `Mostrando ${ini + 1}‚Äì${Math.min(fim, total)} de ${total}`
              : "Nenhum resultado";

    document.getElementById("pageIndicator").textContent =
        `${currentPage} / ${totalPaginas}`;
}

/* =======================================================
   10. EVENTOS
======================================================= */
let buscaTimer = null;

document.getElementById("filtroAluno").addEventListener("input", function () {
    clearTimeout(buscaTimer);
    buscaTimer = setTimeout(() => {
        searchTerm = this.value;
        renderizarTabela(1);
    }, 60);
});

document.getElementById("filtroStatus").onchange = e => {
    statusFilter = e.target.value;
    renderizarTabela(1);
};

document.getElementById("filtroTurma").onchange = e => {
    turmaFilter = e.target.value;
    renderizarTabela(1);
};

document.getElementById("pageSize").onchange = e => {
    pageSize = parseInt(e.target.value);
    renderizarTabela(1);
};

document.getElementById("clearFilters").onclick = () => {
    searchTerm = "";
    statusFilter = "";
    turmaFilter = "";
    document.getElementById("filtroAluno").value = "";
    renderizarTabela(1);
};

document.getElementById("firstPage").onclick = () => renderizarTabela(1);
document.getElementById("prevPage").onclick = () => renderizarTabela(currentPage - 1);
document.getElementById("nextPage").onclick = () => renderizarTabela(currentPage + 1);
document.getElementById("lastPage").onclick = () => {
    const total = aplicarBusca().length;
    renderizarTabela(Math.ceil(total / pageSize));
};

document.querySelectorAll("th[data-sort]").forEach(th => {
    th.onclick = () => {
        const key = th.dataset.sort;
        if (sortKey === key) sortDir = sortDir === "asc" ? "desc" : "asc";
        else { sortKey = key; sortDir = "asc"; }
        renderizarTabela(1);
    };
});

/* =======================================================
   11. MODAL ‚Äî CARREGAR ALUNO
======================================================= */
function editarPorId(id) {
    const aluno = alunos.find(a => a.id === id);
    if (!aluno) return alert("Aluno n√£o encontrado!");

    document.getElementById("editAlunoId").value = aluno.id;
    document.getElementById("editNome").value = aluno.nome;
    document.getElementById("editMatricula").value = aluno.matricula;
    document.getElementById("editAtivo").value = aluno.ativo ? "true" : "false";
    document.getElementById("editDataNasc").value = aluno.data_nascimento || "";
    document.getElementById("editSexo").value = aluno.sexo || "";

    document.getElementById("editRua").value = aluno.rua || "";
    document.getElementById("editNumero").value = aluno.numero || "";
    document.getElementById("editCep").value = aluno.cep || "";
    document.getElementById("editBairro").value = aluno.bairro || "";
    document.getElementById("editCidade").value = aluno.cidade || "";
    document.getElementById("editEstado").value = aluno.estado || "";

    document.getElementById("editNee").value =
        aluno.possui_necessidade_especial ? "true" : "false";

    carregarTurmasModal(aluno.turma?.nome || "");
    carregarResponsaveisModal(aluno.responsaveis || []);

    $("#modalEditarAluno").modal("show");
}

/* =======================================================
   12. TURMAS NO MODAL
======================================================= */
function carregarTurmasModal(turmaAtual) {
    const sel = document.getElementById("editTurma");
    sel.innerHTML = "";

    let turmas = [...new Set(alunos.map(a => turmaLabel(a)).filter(Boolean))];
    turmas.sort();

    sel.innerHTML =
        `<option value="">Selecione‚Ä¶</option>` +
        turmas.map(t => `<option value="${t}" ${t === turmaAtual ? "selected" : ""}>${t}</option>`).join("");
}

/* =======================================================
   13. RESPONS√ÅVEIS
======================================================= */
const listaResp = document.getElementById("listaResponsaveis");
const tplResp = document.getElementById("templateResponsavel");

function criarRespBloco(r) {
    const c = tplResp.content.cloneNode(true);

    c.querySelector(".respId").value = r?.id || "";
    c.querySelector(".respNome").value = r?.nome || "";
    c.querySelector(".respCpf").value = r?.cpf || "";
    c.querySelector(".respParentesco").value = r?.parentesco || "";
    c.querySelector(".respTelefone").value = r?.telefone || "";
    c.querySelector(".respEmail").value = r?.email || "";
    c.querySelector(".respIdentidade").value = r?.identidade || "";
    c.querySelector(".respEscolaridade").value = r?.escolaridade || "";
    c.querySelector(".respProfissao").value = r?.profissao || "";

    c.querySelector(".btnRemoverResponsavel").onclick = function () {
        this.closest(".responsavel-bloco").remove();
    };

    listaResp.appendChild(c);
}

function carregarResponsaveisModal(lista) {
    listaResp.innerHTML = "";
    lista.forEach(r => criarRespBloco(r));
}

document.getElementById("btnAddResponsavel").onclick = () => {
    criarRespBloco({});
};

/* =======================================================
   14. SALVAR ALTERA√á√ïES
======================================================= */
document.getElementById("btnSalvarAluno").onclick = () => {

    const id = document.getElementById("editAlunoId").value;

    const payload = {
        nome: document.getElementById("editNome").value,
        ativo: document.getElementById("editAtivo").value === "true",
        data_nascimento: document.getElementById("editDataNasc").value,
        sexo: document.getElementById("editSexo").value,
        turma: document.getElementById("editTurma").value,
        rua: document.getElementById("editRua").value,
        numero: document.getElementById("editNumero").value,
        cep: document.getElementById("editCep").value,
        bairro: document.getElementById("editBairro").value,
        cidade: document.getElementById("editCidade").value,
        estado: document.getElementById("editEstado").value,
        possui_necessidade_especial: document.getElementById("editNee").value === "true",
        responsaveis: []
    };

    document.querySelectorAll(".responsavel-bloco").forEach(bl => {
        payload.responsaveis.push({
            id: bl.querySelector(".respId").value || null,
            nome: bl.querySelector(".respNome").value,
            cpf: bl.querySelector(".respCpf").value,
            parentesco: bl.querySelector(".respParentesco").value,
            telefone: bl.querySelector(".respTelefone").value,
            email: bl.querySelector(".respEmail").value,
            identidade: bl.querySelector(".respIdentidade").value,
            escolaridade: bl.querySelector(".respEscolaridade").value,
            profissao: bl.querySelector(".respProfissao").value,
        });
    });

    fetch(`/alunos/${id}/editar_completo/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(payload)
    })
        .then(r => r.json())
        .then(d => {
            if (d.success) location.reload();
            else alert("Erro: " + d.error);
        })
        .catch(err => alert("Erro inesperado ao salvar."));
};

/* =======================================================
   INICIAR
======================================================= */
renderizarTabela(1);
</script>

</body>
</html>
