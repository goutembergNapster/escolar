<form id="formChamada">
  <input type="hidden" id="turmaId" value="{{ turma.id }}">
  <input type="hidden" id="disciplinaId" value="{{ disciplina.id }}">

  <div class="form-group mb-3">
    <label for="dataChamada">Data</label>
    <input type="date" class="form-control" id="dataChamada" name="data" required value="{{ today|default:'' }}">
  </div>

  <table class="table table-bordered table-hover table-striped">
    <thead class="table-light">
      <tr>
        <th>Nome do Aluno</th>
        <th>Presença</th>
        <th>Observações</th>
      </tr>
    </thead>
    <tbody>
      {% for aluno in alunos %}
      <tr>
        <td>{{ aluno.nome }}</td>
        <td>
          <div class="form-check form-switch">
            <input class="form-check-input presenca" type="checkbox" data-id="{{ aluno.id }}" checked>
            <label class="form-check-label">Presente</label>
          </div>
        </td>
        <td>
          <input type="text" class="form-control observacao" data-id="{{ aluno.id }}" placeholder="Observações">
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <button type="submit" class="btn btn-primary">Salvar Chamada</button>
</form>

<script>
  document.getElementById('formChamada')?.addEventListener('submit', function (e) {
    e.preventDefault();

    const turmaId = document.getElementById('turmaId').value;
    const disciplinaId = document.getElementById('disciplinaId').value;
    const presencas = [];

    document.querySelectorAll('.presenca').forEach(checkbox => {
      const alunoId = checkbox.dataset.id;
      const presente = checkbox.checked;
      const observacao = document.querySelector(`.observacao[data-id="${alunoId}"]`).value;

      presencas.push({
        aluno_id: alunoId,
        presente: presente,
        observacao: observacao
      });
    });

    fetch('{% url "salvar_chamada" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        turma_id: turmaId,
        disciplina_id: disciplinaId,
        presencas: presencas
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Chamada salva com sucesso!');
        location.reload();
      } else {
        alert(data.erro || 'Erro ao salvar chamada!');
      }
    });
  });
</script>
